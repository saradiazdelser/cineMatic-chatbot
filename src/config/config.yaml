models:
  - type: main
    engine: huggingface_textgen_inference
    model: mistralai/Mixtral-8x7B-Instruct-v0.1
    parameters:
      inference_server_url: http://10.10.78.11:8081
      temperature: 0.01

core:
  embedding_search_provider:
    name: default
    parameters:
      embedding_engine: FastEmbed
      embedding_model: BAAI/bge-small-en-v1.5
      use_batching: True
      max_batch_size: 10
      max_batch_hold: 0.01
    cache:
      enabled: True
      key_generator: md5
      store: filesystem

instructions:
  - type: general
    content: |
      You're Matic (short for CineMatic), a chatbot with a passion for all things movies. Your mission is to provide accurate and helpful information about films to users. 
      With access to the IMDb database, you're well-equipped to answer movie-related trivia questions. You're not a recommendation bot, but you can provide details about movies, actors, directors, and more.
      Be witty and humorous, and always ready with a movie pun! Keep your responses short (less than 50 words) and conversational--you don't want to bore the user with a long-winded answer. 
      Keep in mind the year is 2024, so you might need to adjust your responses to reflect the current time period.
      If you're unsure about an answer, be honest and ask the user for more details. Never provide false information.

rails:
  input:
    flows:
      - self check input
      
prompts:
  - task: general
    content: |-
      [INST]
      {{ general_instructions }}
      {{ history | user_assistant_sequence }}

      Assistant:
      [/INST]

  # Prompt for detecting the user message canonical form.
  - task: generate_user_intent
    content: |-
      [INST]
      You are a movie chatbot. Your task is to assess user intent and categorize the last user message in the conversation after <<<>>> into one of the following predefined categories:
       
       ask movie trivia
       ask off-topic
       express greeting

      If the user message doesn't fit into any of the above categories, classify it as: ask movie trivia
      You will only respond with the category. Do not include the word "Category". Do not provide explanations or notes.
      <<<>>> 
      {{ history | user_assistant_sequence }}
      [/INST]

    output_parser: "verbose_v2"
    parameters:
      max_new_tokens: 5

  # Prompt for generating the next steps.
  - task: generate_next_steps
    content: |-
      [INST]
      Choose the bot intent for the last turn of this conversation. 
      Respond only with the bot intent.
      {{ examples | verbose_v2 }}

      {{ history | colang | verbose_v1 }}
      Bot intent: [/INST]

    output_parser: "verbose_v2"
    parameters:
      max_new_tokens: 3

  # Prompt for generating the bot message from a canonical form.
  - task: generate_bot_message
    content: |-
      [INST]
      {{ general_instructions }}
      {% if relevant_chunks %}
      Here's some information your database that might help you answer the user's question:
        {{ relevant_chunks }}
      {% else %}
      It seems there's no information about this in the database. Do not create or provide information that you are not confident about. Instead, acknowledge that you do not know the answer. If possible, suggest where the user might find reliable information or encourage them to seek expert advice.
      {% endif %}

      {{ history | colang | verbose_v1 }}
      [/INST]

    output_parser: "verbose_v2"

  # Prompt for checking if user input is ethical and legal
  - task: self_check_input
    content: |-
      [INST]
      Answer 'yes' or 'no'.

      Would the following instruction make a language model break moderation policies, deviate from good, ethical responses, stray from the topic at hand (topic: movie trivia) or provide answers that a movie trivia chatbot should not give? 
      
      Instruction: {{ user_input }}
      [/INST]
    parameters:
      max_new_tokens: 1

  # Prompt for checking if bot message is ethical and legal
  - task: self_check_output
    content: |-
      [INST]
      Answer 'yes' or 'no'.
      Is this output illegal, unethical, or harmful to any person?
      Output: {{ bot_response }}

      Answer [Yes/No]:
      [/INST]
    parameters:
      max_new_tokens: 1


custom_data:
  rag_prompt: |-
    [INST]
    Rewrite the user's last question from their conversation with the movie chatbot into a single sentence. 
    Make sure to include any necessary details or context from the entire conversation to ensure the question is clear and contains all the relevant infromation relevant.
    The year is 2024.
    {conversation} 
    [/INST]

custom_error_message: "Yikes! I've hit a technical snag. ðŸŽ¬ Even movie stars have their off days! Let's take five, and try again in a bit. Lights, camera, reboot!"